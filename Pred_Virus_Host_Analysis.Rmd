---
title: "Pred_Virus_Host"
author: "Thomas Nicholson"
date: "3/9/2020"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
#library(comparativeSRA)
library(ggplot2)
```


```{r archaeal_proteins_and_hmms}
file_path <- "~/PredVirusHost/update_march_2020/"

proteins <- read.table(paste(file_path, "archaeal_virus_lookup.txt", sep = ""), sep = "\t", header = F, as.is = T, fill = T)

head(proteins)
colnames(proteins) <- c("protein_accession", "protein_description", "genome")

hmms <- read.table(paste(file_path, "arVOG_protein_hmm_list.txt", sep = ""), sep = "\t", header = F, as.is = T)

head(hmms)
colnames(hmms) <- c("protein_accession", "hmm_accession")

dat <- hmms %>% left_join(proteins, by = "protein_accession")

dat <- dat %>% mutate(protein_description = ifelse(grepl("hypothetical", protein_description), "hypothetical protein", protein_description))
dat <- dat %>% mutate(protein_description = ifelse(grepl("ORF", protein_description), "hypothetical protein", protein_description))
dat <- dat %>% mutate(protein_description = ifelse(grepl("unknown", protein_description), "hypothetical protein", protein_description))


proteinDescr <- dat %>% group_by(hmm_accession) %>% summarise(protein_descriptions = paste(unique(protein_description), collapse = ", "))

dat <- dat %>% mutate(genome = str_replace_all(genome, "Virus_PhiCh1_complete_genome.", "Natrialba_phage_PhiCh1"))
dat <- dat %>% mutate(genome = str_replace_all(genome, "TPA:", ""))


genomes <- dat %>% group_by(hmm_accession) %>% summarise(genomes = paste(unique(genome), collapse = ", "))

genera <- dat %>% separate(col = genome, into = c("genus", "other"), sep = "_", remove = F, extra = "merge") %>% group_by(hmm_accession) %>% summarise(genera = paste(unique(genus), collapse = ", "))

counts <- dat %>% group_by(hmm_accession) %>% summarise(count = length(unique(protein_description)))


summaryData <- proteinDescr %>% full_join(genomes, by = "hmm_accession") %>% full_join(counts, by = "hmm_accession") %>% full_join(genera, by = "hmm_accession")

summaryData <- summaryData %>% mutate(protein_descriptions = ifelse(count > 1, str_replace(string = protein_descriptions, pattern = ", hypothetical protein,", replacement = ","), protein_descriptions)) %>% mutate(protein_descriptions = ifelse(count > 1, str_replace(string = protein_descriptions, pattern = ", hypothetical protein", replacement = ""), protein_descriptions))%>% mutate(protein_descriptions = ifelse(count > 1, str_replace(string = protein_descriptions, pattern = "hypothetical protein,", replacement = ""), protein_descriptions))

save(summaryData, file = "~/bin/PredVirusHost/archaeal_hmm_accessions_descriptions.Rda")
write.csv(summaryData, file = "~/bin/PredVirusHost/archeaeal_hmm_accessions_descriptions.csv", row.names = F, quote = F)

```

```{r phage_proteins_and_hmms}
file_path <- "~/PredVirusHost/update_march_2020/"

proteins <- read.table(paste(file_path, "phage_lookup.txt", sep = ""), sep = "\t", header = F, as.is = T, quote = "", comment.char = "")

proteins <- proteins %>% mutate(V2 = str_replace_all(string = V2, pattern = "_\\[2", replacement = "__2")) %>% mutate(V2 = str_replace_all(string = V2, pattern = "\\]", ""))

proteins <- proteins %>% separate(col = V2, into = c("protein_description", "genome"), sep = "_\\[", remove = T, extra = "merge")

proteins[proteins == ""] <- "hypothetical protein"
proteins[is.na(proteins)] <- "hypothetical protein"

head(proteins)
colnames(proteins) <- c("protein_accession", "protein_description", "genome")

hmms <- read.table(paste(file_path, "baPOG_protein_hmm_list.txt", sep = ""), sep = "\t", header = F, as.is = T)

head(hmms)
colnames(hmms) <- c("protein_accession", "hmm_accession")

dat <- hmms %>% left_join(proteins, by = "protein_accession")

dat <- dat %>% mutate(protein_description = ifelse(grepl("hypothetical", protein_description), "hypothetical protein", protein_description))
dat <- dat %>% mutate(protein_description = ifelse(grepl("ORF", protein_description), "hypothetical protein", protein_description))
dat <- dat %>% mutate(protein_description = ifelse(grepl("unknown", protein_description), "hypothetical protein", protein_description))

dat <- dat %>% filter(!is.na(protein_description))

proteinDescr <- dat %>% group_by(hmm_accession) %>% summarise(protein_descriptions = paste(unique(protein_description), collapse = ", "))

dat <- dat %>% mutate(genome = str_replace_all(genome, "Virus_PhiCh1_complete_genome.", "Natrialba_phage_PhiCh1"))
dat <- dat %>% mutate(genome = str_replace_all(genome, "TPA:", ""))


genomes <- dat %>% group_by(hmm_accession) %>% summarise(genomes = paste(unique(genome), collapse = ", "))

genera <- dat %>% separate(col = genome, into = c("genus", "other"), sep = "_", remove = F, extra = "merge") %>% group_by(hmm_accession) %>% summarise(genera = paste(unique(genus), collapse = ", "))

counts <- dat %>% group_by(hmm_accession) %>% summarise(count = length(unique(protein_description)))


summaryData <- proteinDescr %>% full_join(genomes, by = "hmm_accession") %>% full_join(counts, by = "hmm_accession") %>% full_join(genera, by = "hmm_accession")

summaryData <- summaryData %>% mutate(protein_descriptions = ifelse(count > 1, str_replace(string = protein_descriptions, pattern = ", hypothetical protein,", replacement = ","), protein_descriptions)) %>% mutate(protein_descriptions = ifelse(count > 1, str_replace(string = protein_descriptions, pattern = ", hypothetical protein", replacement = ""), protein_descriptions))%>% mutate(protein_descriptions = ifelse(count > 1, str_replace(string = protein_descriptions, pattern = "hypothetical protein,", replacement = ""), protein_descriptions))

save(summaryData, file = "~/bin/PredVirusHost/phage_hmm_accessions_descriptions.Rda")
write.csv(summaryData, file = "~/bin/PredVirusHost/phage_hmm_accessions_descriptions.csv", row.names = F, quote = F)

```

